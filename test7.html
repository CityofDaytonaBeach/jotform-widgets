<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HIPAA Employee Lookup Widget</title>

<!-- Jotform Widget API -->
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }

  #resultsContainer {
    position: relative;
    width: 100%;
  }

  #searchUser {
    width: 100%;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    z-index: 9999;
    max-height: 180px;
    overflow-y: auto;
  }

  .dropdown-item {
    padding: 6px;
    cursor: pointer;
  }

  .dropdown-item:hover {
    background: #eee;
  }
</style>
</head>

<body>

<div id="resultsContainer">
  <input id="searchUser" type="text" placeholder="Search employee..." autocomplete="off">
</div>

<script>
console.clear();
console.log("ðŸ”§ HIPAA-Safe Jotform Employee Lookup Widget Initialized");

// ----------------------------------------------------------------------
// CONFIG
// ----------------------------------------------------------------------
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
let users = [];

// ----------------------------------------------------------------------
// LOAD EMPLOYEE DATA
// ----------------------------------------------------------------------
async function loadUsers() {
  try {
    const res = await fetch(API_URL);

    if (!res.ok) throw new Error("Supabase fetch failed: " + res.status);

    users = await res.json();
    console.log("ðŸ“¦ Loaded employee dataset:", users.length);
  } catch (err) {
    console.error("âŒ Error fetching employee list:", err);
  }
}
loadUsers();

// ----------------------------------------------------------------------
// AUTOCOMPLETE BEHAVIOR
// ----------------------------------------------------------------------
const searchBox = document.getElementById("searchUser");
const container = document.getElementById("resultsContainer");

let debounce = null;

searchBox.addEventListener("input", (e) => {
  clearTimeout(debounce);
  debounce = setTimeout(() => handleSearch(e.target.value.trim().toLowerCase()), 150);
});

function handleSearch(query) {
  container.querySelectorAll(".dropdown").forEach(d => d.remove());
  if (!query) return;

  const matches = users
    .filter(u => (u.displayname || "").toLowerCase().includes(query))
    .slice(0, 8);

  console.log("ðŸ” Matches:", matches);

  if (!matches.length) return;

  const dd = document.createElement("div");
  dd.className = "dropdown";

  matches.forEach(u => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = u.displayname;

    item.onclick = () => {
      console.log("âœ… Selected user:", u);
      searchBox.value = u.displayname;
      dd.remove();

      sendToJotform(u); // HIPAA-safe field export
    };

    dd.appendChild(item);
  });

  container.appendChild(dd);
}

document.addEventListener("click", (e) => {
  if (!container.contains(e.target)) {
    container.querySelectorAll(".dropdown").forEach(d => d.remove());
  }
});

// ----------------------------------------------------------------------
// HIPAA-COMPLIANT DATA EXPORT TO JOTFORM
// ----------------------------------------------------------------------
function sendToJotform(u) {
  const payload = {
    valid: true,
    value: "",  // Widgetâ€™s own value intentionally blank for HIPAA

    data: {
      fullName: u.displayname || "",
      email: u.mail || "",
      jobTitle: u.jobtitle || "",
      department: u.department || "",
      manager: u.manager || "",
      managerEmail: u.managermail || "",
      employeeId: u.employeeId || "",
      division: u.division || ""
    }
  };

  console.log("ðŸ“¤ Sending structured data to Jotform:", payload);

  try {
    JFCustomWidget.sendData(payload);
    console.log("ðŸ“¨ Data sent successfully.");
  } catch (err) {
    console.error("âŒ sendData error:", err);
  }
}

// ----------------------------------------------------------------------
// JOTFORM READY EVENT
// ----------------------------------------------------------------------
if (window.JFCustomWidget) {
  JFCustomWidget.subscribe("ready", () => {
    console.log("ðŸŸ¢ Widget Ready (Jotform handshake successful)");
    JFCustomWidget.sendData({ valid: true, value: "" });
  });
}
</script>

</body>
</html>
