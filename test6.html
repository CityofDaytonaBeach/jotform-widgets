<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Employee Lookup Widget</title>

<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
  #resultsContainer {
    position: relative;
    width: 100%;
  }
  #searchUser {
    width: 100%;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    z-index: 99;
    max-height: 180px;
    overflow-y: auto;
  }
  .dropdown-item {
    padding: 6px;
    cursor: pointer;
  }
  .dropdown-item:hover {
    background: #eee;
  }
</style>
</head>

<body>

<div id="resultsContainer">
  <input id="searchUser" type="text" placeholder="Search employee..." autocomplete="off">
</div>

<script>
console.clear();
console.log("HIPAA-SAFE Employee Widget Loaded");

const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
let users = [];

/* ---- Load Users ---- */
async function loadUsers() {
  try {
    const r = await fetch(API_URL);
    users = await r.json();
    console.log("Loaded Employees:", users.length);
  } catch (e) {
    console.error("Error loading users:", e);
  }
}
loadUsers();

/* ---- Autocomplete ---- */
const searchBox = document.getElementById("searchUser");
const container = document.getElementById("resultsContainer");
let timer = null;

searchBox.addEventListener("input", e => {
  clearTimeout(timer);
  timer = setTimeout(() => showMatches(e.target.value.trim().toLowerCase()), 120);
});

function showMatches(q) {
  container.querySelectorAll(".dropdown").forEach(d => d.remove());
  if (!q) return;

  const matches = users
    .filter(u => u.displayname.toLowerCase().includes(q))
    .slice(0, 8);

  console.log("Matches:", matches);

  if (!matches.length) return;

  const dd = document.createElement("div");
  dd.className = "dropdown";

  matches.forEach(u => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = u.displayname;

    item.onclick = () => {
      console.log("Selected:", u);
      searchBox.value = u.displayname;
      dd.remove();

      /* ---- HIPAA-SAFE: Send JSON Back to Jotform ---- */
      JFCustomWidget.sendData({
        valid: true,
        value: JSON.stringify({
          fullName: u.displayname,
          email: u.mail,
          jobTitle: u.jobtitle,
          department: u.department,
          manager: u.manager,
          managerEmail: u.managermail,
          employeeId: u.employeeId,
          division: u.division
        })
      });

      console.log("Sent JSON to Jotform.");
    };

    dd.appendChild(item);
  });

  container.appendChild(dd);
}

/* ---- Jotform lifecycle ---- */
if (window.JFCustomWidget) {
  JFCustomWidget.subscribe("ready", () => {
    console.log("Widget Ready");
    JFCustomWidget.sendData({ valid: true, value: "" });
  });
}
</script>
</body>
</html>
