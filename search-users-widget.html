<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Search Widget</title>
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; }
  #resultsContainer { position: relative; width: 100%; }
  #searchUser { width: 100%; padding: 4px; margin: 0; box-sizing: border-box; }
  .dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: #fff; border: 1px solid #ccc; z-index: 9999;
    max-height: 180px; overflow-y: auto;
  }
  .dropdown-item { cursor: pointer; padding: 2px 4px; margin: 0; }
  .dropdown-item:hover { background: #f0f0f0; }
</style>
</head>
<body>
<div id="resultsContainer">
  <input type="text" id="searchUser" placeholder="Search employee..." autocomplete="off" />
</div>

<script>
let users = [];
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
const searchInput = document.getElementById("searchUser");
const resultsContainer = document.getElementById("resultsContainer");

console.clear();
console.log("ðŸ” Loading User Search Widget...");

function sendWidgetData(data) {
  try { if (window.JFCustomWidget) { JFCustomWidget.sendData(data); } }
  catch(err) { console.warn("âš  sendData failed:", err); }
}

// Function to fill form fields via postMessage
function fillFormFields(user) {
  const fieldMappings = {
    'input_5': user.displayname || '',
    'input_6': user.mail || '',
    'input_7': user.jobtitle || '',
    'input_8': user.department || '',
    'input_9': user.manager || '',
    'input_10': user.managermail || '',
    'input_11': user.employeeId || '',
    'input_12': user.division || ''
  };

  // Send via postMessage to parent
  Object.keys(fieldMappings).forEach(fieldId => {
    window.parent.postMessage({
      type: 'populate',
      qid: fieldId,
      value: fieldMappings[fieldId]
    }, '*');
  });

  console.log("âœ… Sent field data to parent form:", fieldMappings);
}

async function loadUsers() {
  try {
    const res = await fetch(API_URL);
    users = await res.json();
    console.log(`âœ… Loaded ${users.length} users`);
  } catch (err) {
    console.error("âŒ Error fetching users:", err);
  }
}

loadUsers();

searchInput.addEventListener("input", (e) => {
  const query = e.target.value.trim().toLowerCase();
  resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
  if (!query) return;

  const matches = users.filter(u => (u.displayname||"").toLowerCase().includes(query)).slice(0,8);
  if (matches.length === 0) return;

  const dropdown = document.createElement("div");
  dropdown.className = "dropdown";

  matches.forEach(u => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = u.displayname || "(No Name)";
    item.addEventListener("click", () => {
      searchInput.value = u.displayname || "";
      dropdown.remove();
      console.log("âœ… Selected user:", u);

      // Fill form fields directly
      fillFormFields(u);

      // Also send to widget value
      sendWidgetData({ valid: true, value: JSON.stringify(u) });
    });
    dropdown.appendChild(item);
  });

  resultsContainer.appendChild(dropdown);
});

document.addEventListener("click", (e) => {
  if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
    resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
  }
});

if (window.JFCustomWidget) {
  JFCustomWidget.subscribe("ready", function() {
    console.log("âœ… Jotform Widget Ready");
    sendWidgetData({ valid: true, value: "" });
  });
}
</script>
</body>
</html>
