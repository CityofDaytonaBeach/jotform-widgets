<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employee Lookup Widget</title>
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
  #resultsContainer {
    position: relative;
    width: 100%;
  }
  #searchUser {
    width: 100%;
    padding: 6px;
    margin: 0;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    z-index: 9999;
    max-height: 180px;
    overflow-y: auto;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .dropdown-item {
    cursor: pointer;
    padding: 6px 8px;
  }
  .dropdown-item:hover {
    background: #f0f0f0;
  }
</style>
</head>

<body>
<div id="resultsContainer">
  <input type="text" id="searchUser" placeholder="Search employee..." autocomplete="off" />
</div>

<script>
console.clear();
console.log("ðŸ” Loading Employee Lookup Widget...");

// ===== CONFIG =====
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users"; // change if needed

let users = [];
const searchInput = document.getElementById("searchUser");
const resultsContainer = document.getElementById("resultsContainer");

// ===== UTILITIES =====
function sendWidgetData(data) {
  try {
    if (window.JFCustomWidget) JFCustomWidget.sendData(data);
  } catch (err) {
    console.warn("âš  sendData failed:", err);
  }
}

function fillFormFields(user) {
  const fieldMappings = {
    'input_5': user.displayname || '',
    'input_6': user.mail || '',
    'input_7': user.jobtitle || '',
    'input_8': user.department || '',
    'input_9': user.manager || '',
    'input_10': user.managermail || '',
    'input_11': user.employeeId || '',
    'input_12': user.division || ''
  };

  Object.keys(fieldMappings).forEach(fieldId => {
    window.parent.postMessage({
      type: 'populate',
      qid: fieldId,
      value: fieldMappings[fieldId]
    }, '*');
  });

  console.log("âœ… Sent field data to parent form:", fieldMappings);
}

// ===== LOAD USERS =====
async function loadUsers() {
  try {
    const res = await fetch(API_URL);
    users = await res.json();
    console.log(`âœ… Loaded ${users.length} users`);
  } catch (err) {
    console.error("âŒ Error fetching users:", err);
  }
}

loadUsers();

// ===== AUTOCOMPLETE =====
searchInput.addEventListener("input", (e) => {
  const query = e.target.value.trim().toLowerCase();
  resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
  if (!query) return;

  const matches = users
    .filter(u => (u.displayname || "").toLowerCase().includes(query))
    .slice(0, 8);
  if (!matches.length) return;

  const dropdown = document.createElement("div");
  dropdown.className = "dropdown";

  matches.forEach(u => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = u.displayname || "(No Name)";
    item.addEventListener("click", () => {
      searchInput.value = u.displayname || "";
      dropdown.remove();
      console.log("âœ… Selected user:", u);

      fillFormFields(u);
      sendWidgetData({ valid: true, value: JSON.stringify(u) });
    });
    dropdown.appendChild(item);
  });

  resultsContainer.appendChild(dropdown);
});

// ===== CLICK OUTSIDE CLOSE =====
document.addEventListener("click", (e) => {
  if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
    resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
  }
});

// ===== JOTFORM READY =====
if (window.JFCustomWidget) {
  JFCustomWidget.subscribe("ready", function() {
    console.log("âœ… Jotform Widget Ready");
    sendWidgetData({ valid: true, value: "" });
  });
}
</script>
</body>
</html>
