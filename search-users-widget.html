<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<style>
/* Input styling (matches JotForm fields) */
input {
  font-size: 14px;
  padding: 10px;
  width: 100%;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 6px;
  transition: border 0.2s, box-shadow 0.2s;
}

input:focus {
  border-color: #4A90E2;
  box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
  outline: none;
}

/* Autocomplete dropdown */
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-top: none;
  z-index: 1000;
  background-color: #fff;
  max-height: 250px;
  overflow-y: auto;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.autocomplete-item {
  padding: 10px 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.autocomplete-item:hover, .autocomplete-item.active {
  background-color: #f0f8ff;
  color: #333;
  font-weight: 500;
}
</style>
</head>
<body>

<!-- Search input without label -->
<input id="userSearch" placeholder="e.g. lastname, firstname">
<div id="autocomplete-list" class="autocomplete-items"></div>

<script>
// Supabase endpoint
const supabaseUrl = 'https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users';
let users = [];

// Fetch users
async function fetchUsers() {
  try {
    const res = await fetch(supabaseUrl);
    users = await res.json();
  } catch (err) {
    console.error('Error fetching users:', err);
  }
}

// Autocomplete logic
const searchInput = document.getElementById('userSearch');
const autocompleteList = document.getElementById('autocomplete-list');
let currentFocus = -1;

searchInput.addEventListener('input', () => {
  const term = searchInput.value.trim().toLowerCase();
  autocompleteList.innerHTML = '';
  currentFocus = -1;

  if (!term) return;

  const matches = users.filter(u => u.displayname.toLowerCase().includes(term));

  matches.forEach(u => {
    const item = document.createElement('div');
    item.classList.add('autocomplete-item');
    item.innerHTML = u.displayname;
    item.addEventListener('click', () => {
      searchInput.value = u.displayname;
      sendToParent(u);
      autocompleteList.innerHTML = '';
    });
    autocompleteList.appendChild(item);
  });
});

// Keyboard navigation
searchInput.addEventListener('keydown', (e) => {
  const items = autocompleteList.getElementsByClassName('autocomplete-item');
  if (!items) return;

  if (e.key === 'ArrowDown') {
    currentFocus++;
    addActive(items);
  } else if (e.key === 'ArrowUp') {
    currentFocus--;
    addActive(items);
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (currentFocus > -1 && items[currentFocus]) items[currentFocus].click();
  }
});

function addActive(items) {
  removeActive(items);
  if (currentFocus >= items.length) currentFocus = 0;
  if (currentFocus < 0) currentFocus = items.length - 1;
  items[currentFocus].classList.add('active');
}

function removeActive(items) {
  Array.from(items).forEach(item => item.classList.remove('active'));
}

// Send selected user to parent form
function sendToParent(user) {
  window.parent.postMessage({ type: 'populateFields', data: user }, '*');
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (e.target !== searchInput) autocompleteList.innerHTML = '';
});

// Initialize
fetchUsers();
</script>

</body>
</html>
