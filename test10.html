<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Employee Autofill Widget â€“ Diagnostic Mode</title>

<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 10px;
    font-family: Arial, sans-serif;
  }

  #resultsContainer {
    position: relative;
    width: 100%;
  }

  #searchUser {
    width: 100%;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    z-index: 9999;
    max-height: 180px;
    overflow-y: auto;
  }

  .dropdown-item {
    padding: 6px;
    cursor: pointer;
  }

  .dropdown-item:hover {
    background: #eee;
  }
</style>
</head>

<body>

<div id="resultsContainer">
  <input id="searchUser" type="text" placeholder="Search employee..." autocomplete="off">
</div>

<script>
console.clear();
console.log("ðŸ”§ Diagnostic Widget Loaded (Autofill Mode)");

/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const SUPABASE_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

let users = [];
let selectedUser = null;

// Field map must match your form's numeric field IDs
const fieldMap = {
  fullName: 5,
  email: 6,
  jobTitle: 7,
  department: 8,
  manager: 9,
  managerEmail: 10,
  employeeId: 11,
  division: 12
};

/* ----------------------------------------------------------
   LOAD EMPLOYEES FROM SUPABASE
---------------------------------------------------------- */
async function loadEmployees() {
  try {
    const r = await fetch(SUPABASE_URL);
    users = await r.json();
    console.log("ðŸ“¦ Employees loaded:", users.length);
  } catch (e) {
    console.error("âŒ Error fetching Supabase data:", e);
  }
}
loadEmployees();

/* ----------------------------------------------------------
   AUTOCOMPLETE UI
---------------------------------------------------------- */
const searchBox = document.getElementById("searchUser");
const container = document.getElementById("resultsContainer");

let debounce = null;

searchBox.addEventListener("input", e => {
  clearTimeout(debounce);
  debounce = setTimeout(() => handleSearch(e.target.value.trim().toLowerCase()), 150);
});

function handleSearch(query) {
  container.querySelectorAll(".dropdown").forEach(d => d.remove());
  if (!query) return;

  const matches = users
    .filter(u => (u.displayname || "").toLowerCase().includes(query))
    .slice(0, 8);

  console.log("ðŸ” Matches:", matches);

  if (!matches.length) return;

  const dd = document.createElement("div");
  dd.className = "dropdown";

  matches.forEach(u => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = u.displayname;

    item.onclick = () => {
      console.log("ðŸŽ¯ Selected:", u);
      selectedUser = u;

      searchBox.value = u.displayname;
      dd.remove();

      autofill(u);  // direct autofill attempt
    };

    dd.appendChild(item);
  });

  container.appendChild(dd);
}

/* ----------------------------------------------------------
   DIRECT FIELD AUTOFILL
---------------------------------------------------------- */
function autofill(u) {
  const data = [
    { id: fieldMap.fullName,     value: u.displayname },
    { id: fieldMap.email,        value: u.mail },
    { id: fieldMap.jobTitle,     value: u.jobtitle },
    { id: fieldMap.department,   value: u.department },
    { id: fieldMap.manager,      value: u.manager },
    { id: fieldMap.managerEmail, value: u.managermail },
    { id: fieldMap.employeeId,   value: u.employeeId },
    { id: fieldMap.division,     value: u.division }
  ];

  console.log("âž¡ï¸ Attempting direct autofill:", data);

  try {
    JFCustomWidget.setFieldsValueById(data);
    console.log("âœ… Jotform fields updated (widget believes so)");
  } catch (err) {
    console.error("âŒ setFieldsValueById error:", err);
  }

  JFCustomWidget.sendData({
    valid: true,
    value: u.displayname
  });
}

/* ----------------------------------------------------------
   JOTFORM EVENTS + PERMISSION DIAGNOSTIC
---------------------------------------------------------- */
JFCustomWidget.subscribe("ready", () => {
  console.log("ðŸŸ¢ Widget READY");

  // *** THE IMPORTANT DIAGNOSTIC ***
  console.log("ðŸ›‘ Field access allowed:", JFCustomWidget.fieldAccessAllowed);

  JFCustomWidget.sendData({ valid: true, value: "" });
});

JFCustomWidget.subscribe("submit", () => {
  console.log("ðŸ“© Jotform submit event");

  JFCustomWidget.sendSubmit({
    valid: true,
    value: selectedUser ? selectedUser.displayname : ""
  });
});
</script>

</body>
</html>
