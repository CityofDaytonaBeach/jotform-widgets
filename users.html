<!doctype html>
<html>
  <head>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
  </head>

  <body>
    <input 
      id="employeeSearch" 
      placeholder="Search employee..." 
      autocomplete="off"
      style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;"
    />

    <div id="dropdown"></div>

    <script type="text/javascript">
      const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
      let users = [];
      let selectedEmployee = null;

      // Load employees
      async function loadUsers() {
        try {
          const res = await fetch(API_URL);
          users = await res.json();
          console.log("ðŸ“¦ Loaded employees:", users);
        } catch (err) {
          console.error("âŒ Error loading users:", err);
        }
      }
      loadUsers();

      // Build dropdown
      function createDropdown(matches) {
        const container = document.getElementById("dropdown");
        container.innerHTML = "";
        container.style.position = "relative";

        const list = document.createElement("div");
        list.style.position = "absolute";
        list.style.top = "100%";
        list.style.left = "0";
        list.style.right = "0";
        list.style.border = "1px solid #ccc";
        list.style.background = "#fff";
        list.style.zIndex = "9999";
        list.style.maxHeight = "180px";
        list.style.overflowY = "auto";

        matches.forEach(emp => {
          const item = document.createElement("div");
          item.textContent = emp.displayname || "(No Name)";
          item.style.padding = "6px";
          item.style.cursor = "pointer";

          item.addEventListener("click", () => {
            console.log("ðŸŸ¢ Selected employee:", emp);
            selectedEmployee = emp;

            document.getElementById("employeeSearch").value = emp.displayname;
            container.innerHTML = "";

            autoFillEmployee(emp);
          });

          item.addEventListener("mouseover", () => item.style.background = "#f0f0f0");
          item.addEventListener("mouseout", () => item.style.background = "#fff");

          list.appendChild(item);
        });

        container.appendChild(list);
      }

      // Autofill + store value
      function autoFillEmployee(emp) {
        // Build pipe-delimited value
        const output = [
          emp.displayname || "",
          emp.email || "",
          emp.title || "",
          emp.department || "",
          emp.manager || "",
          emp.manager_email || "",
          emp.employee_id || "",
          emp.division || ""
        ].join("|");

        console.log("ðŸ“¤ Widget Output Value:", output);

        // Field autofill mapping â€” starts at input_5
        const fieldMap = [
          { id: "5",  value: emp.displayname || "" },     // Full Name
          { id: "6",  value: emp.email || "" },           // Email
          { id: "7",  value: emp.title || "" },           // Job Title
          { id: "8",  value: emp.department || "" },      // Department
          { id: "9",  value: emp.manager || "" },         // Manager
          { id: "10", value: emp.manager_email || "" },   // Manager Email
          { id: "11", value: emp.employee_id || "" },     // Employee ID
          { id: "12", value: emp.division || "" }         // Division
        ];

        console.log("ðŸ“¥ Autofilling form fields using allowed API:", fieldMap);

        // Allowed API call
        JFCustomWidget.setFieldsValueById(fieldMap);

        // Store widget's value
        JFCustomWidget.storeToField("widget_input", output);
      }

      // Widget engine
      function EmployeeWidget() {
        this.init = init;
        this.getData = getData;

        function init(formData) {
          console.log("ðŸŸ¦ Widget Ready â€” Init Fired");

          document.getElementById("employeeSearch").addEventListener("input", (e) => {
            const q = e.target.value.toLowerCase().trim();
            if (!q) {
              document.getElementById("dropdown").innerHTML = "";
              return;
            }

            const matches = users
              .filter(u => (u.displayname || "").toLowerCase().includes(q))
              .slice(0, 8);

            console.log("ðŸ”Ž Search:", q, "| Matches:", matches.length);

            createDropdown(matches);
          });
        }

        function getData() {
          const value = selectedEmployee
            ? [
                selectedEmployee.displayname,
                selectedEmployee.email,
                selectedEmployee.title,
                selectedEmployee.department,
                selectedEmployee.manager,
                selectedEmployee.manager_email,
                selectedEmployee.employee_id,
                selectedEmployee.division
              ].join("|")
            : "";

          console.log("ðŸ“¨ Final Submit Value:", value);

          return { valid: true, value: value };
        }
      }

      // Jotform events
      JFCustomWidget.subscribe("ready", function (data) {
        const widget = new EmployeeWidget();
        widget.init(data);

        JFCustomWidget.subscribe("submit", function () {
          JFCustomWidget.sendSubmit(widget.getData());
        });
      });
    </script>
  </body>
</html>
