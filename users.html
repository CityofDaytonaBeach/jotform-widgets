<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Employee Search Dropdown</title>

  <style>
    #searchBox {
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      font-size: 15px;
      box-sizing: border-box;
    }

    #resultList {
      width: 100%;
      max-height: 200px;
      border: 1px solid #ccc;
      border-top: none;
      background: white;
      overflow-y: auto;
      display: none;
      position: absolute;
      z-index: 9999;
    }

    .result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .result-item:hover {
      background: #f4f4f4;
    }

    .wrapper {
      position: relative;
      width: 100%;
    }
  </style>
</head>

<body>

<div class="wrapper">
  <input type="text" id="searchBox" placeholder="Search by first or last name...">
  <div id="resultList"></div>
</div>

<script>
  /* ----------------------------------------------------------
     Load employees from Supabase Edge Function
  ---------------------------------------------------------- */
  async function loadEmployees() {
    try {
      const res = await fetch("https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users", {
        method: "GET",
        headers: { "Content-Type": "application/json" }
      });

      const data = await res.json();

      console.log("ðŸ” Loaded employee dataset:", data);

      return data;
    } catch (e) {
      console.error("Error loading employees:", e);
      return [];
    }
  }

  /* ----------------------------------------------------------
     Build interactive search dropdown
  ---------------------------------------------------------- */
  async function initSearch() {
    const employees = await loadEmployees();

    const searchBox = document.getElementById("searchBox");
    const resultList = document.getElementById("resultList");

    searchBox.addEventListener("input", () => {
      const query = searchBox.value.toLowerCase().trim();
      resultList.innerHTML = "";

      if (!query) {
        resultList.style.display = "none";
        return;
      }

      const filtered = employees.filter(emp =>
        emp.displayname.toLowerCase().includes(query)
      );

      filtered.forEach(emp => {
        const div = document.createElement("div");
        div.classList.add("result-item");
        div.textContent = emp.displayname;

        div.onclick = () => {
          searchBox.value = emp.displayname;
          resultList.style.display = "none";

          console.log("ðŸ‘¤ Employee selected:", emp);

          // Autopopulated fields (console logging included)
          const mappedFields = {
            fullName: emp.displayname,
            email: emp.mail,
            jobTitle: emp.jobtitle,
            department: emp.department,
            manager: emp.manager,
            managerEmail: emp.managermail,
            employeeId: emp.employeeId,
            division: emp.division
          };

          console.log("ðŸ“Œ Autopopulated fields:", mappedFields);
        };

        resultList.appendChild(div);
      });

      resultList.style.display = filtered.length ? "block" : "none";
    });

    document.addEventListener("click", e => {
      if (!e.target.closest(".wrapper")) {
        resultList.style.display = "none";
      }
    });
  }

  initSearch();
</script>

</body>
</html>
