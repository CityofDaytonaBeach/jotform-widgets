<!doctype html>
<html>
<head>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>

<body>
  <div id="widgetContainer">
    <input 
      id="employeeSearch"
      placeholder="Search employee..."
      autocomplete="off"
      style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;"
    />
    <div id="dropdown"></div>
  </div>

<script>
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

let users = [];
let selectedEmployee = null;

async function loadUsers() {
  const res = await fetch(API_URL);
  users = await res.json();
  console.log("ğŸ“¦ Loaded employees:", users.length);
}

function createDropdown(matches) {
  const dropdown = document.getElementById("dropdown");
  dropdown.innerHTML = "";
  dropdown.style.position = "relative";

  const list = document.createElement("div");
  list.style.position = "absolute";
  list.style.top = "100%";
  list.style.left = "0";
  list.style.right = "0";
  list.style.background = "#fff";
  list.style.border = "1px solid #ccc";
  list.style.zIndex = "9999";
  list.style.maxHeight = "180px";
  list.style.overflowY = "auto";

  matches.forEach(emp => {
    const item = document.createElement("div");
    item.style.padding = "6px";
    item.style.cursor = "pointer";
    item.textContent = emp.displayname;

    item.onclick = () => {
      console.log("ğŸŸ¢ Selected employee:", emp);
      selectedEmployee = emp;
      document.getElementById("employeeSearch").value = emp.displayname;
      dropdown.innerHTML = "";
      autoFill(emp);
    };

    item.onmouseover = () => item.style.background = "#f0f0f0";
    item.onmouseout = () => item.style.background = "#fff";

    list.appendChild(item);
  });

  dropdown.appendChild(list);
}

function autoFill(emp) {
  const pipeData = [
    emp.displayname || "",
    emp.mail || "",
    emp.jobtitle || "",
    emp.department || "",
    emp.manager || "",
    emp.managermail || "",
    emp.employeeId || "",
    emp.division || ""
  ].join("|");

  console.log("ğŸ“¤ Pipe value:", pipeData);

  const fieldMap = [
    { id: "5",  value: emp.displayname || "" },
    { id: "6",  value: emp.mail || "" },
    { id: "7",  value: emp.jobtitle || "" },
    { id: "8",  value: emp.department || "" },
    { id: "9",  value: emp.manager || "" },
    { id: "10", value: emp.managermail || "" },
    { id: "11", value: emp.employeeId || "" },
    { id: "12", value: emp.division || "" }
  ];

  console.log("ğŸ“¥ Autofill map:", fieldMap);

  JFCustomWidget.setFieldsValueById(fieldMap);
  JFCustomWidget.storeToField("widget_input", pipeData);
}

function EmployeeWidget() {
  this.init = async function() {
    await loadUsers();

    const input = document.getElementById("employeeSearch");

    input.addEventListener("input", () => {
      const q = input.value.toLowerCase().trim();
      if (!q) {
        document.getElementById("dropdown").innerHTML = "";
        return;
      }

      const matches = users.filter(u =>
        u.displayname.toLowerCase().includes(q)
      ).slice(0, 8);

      console.log("ğŸ” Matches:", matches.length);

      createDropdown(matches);
    });
  };

  this.getData = function() {
    if (!selectedEmployee) return { valid: true, value: "" };

    const value = [
      selectedEmployee.displayname,
      selectedEmployee.mail,
      selectedEmployee.jobtitle,
      selectedEmployee.department,
      selectedEmployee.manager,
      selectedEmployee.managermail,
      selectedEmployee.employeeId,
      selectedEmployee.division
    ].join("|");

    return { valid: true, value };
  };
}

// Jotform events
JFCustomWidget.subscribe("ready", () => {
  const widget = new EmployeeWidget();
  widget.init();

  JFCustomWidget.subscribe("submit", () => {
    JFCustomWidget.sendSubmit(widget.getData());
  });
});
</script>

</body>
</html>
