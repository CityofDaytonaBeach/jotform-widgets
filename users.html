<!doctype html>
<html>
<head>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>

<body>
<div id="widget"></div>

<script>
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

let users = [];
let selectedEmployee = null;

// Load Supabase records
async function loadUsers() {
  const res = await fetch(API_URL);
  users = await res.json();
  console.log("ğŸ“¦ Loaded employees:", users.length);
}

// Create widget UI dynamically after iframe loads
function buildUI() {
  const container = document.getElementById("widget");

  const input = document.createElement("input");
  input.id = "employeeSearch";
  input.placeholder = "Search employee...";
  input.style.width = "100%";
  input.style.padding = "6px";
  input.style.border = "1px solid #ccc";
  input.style.borderRadius = "4px";

  const dropdown = document.createElement("div");
  dropdown.id = "dropdown";
  dropdown.style.position = "relative";

  container.appendChild(input);
  container.appendChild(dropdown);

  input.addEventListener("input", () => {
    const q = input.value.toLowerCase().trim();
    if (!q) return dropdown.innerHTML = "";

    const matches = users.filter(u =>
      (u.displayname || "").toLowerCase().includes(q)
    ).slice(0, 8);

    console.log("ğŸ” Matches:", matches.length);

    buildDropdown(matches);
  });
}

// Create dropdown
function buildDropdown(matches) {
  const dropdown = document.getElementById("dropdown");
  dropdown.innerHTML = "";

  const list = document.createElement("div");
  list.style.position = "absolute";
  list.style.top = "100%";
  list.style.left = "0";
  list.style.right = "0";
  list.style.background = "#fff";
  list.style.border = "1px solid #ccc";
  list.style.zIndex = "9999";
  list.style.maxHeight = "180px";
  list.style.overflowY = "auto";

  matches.forEach(emp => {
    const item = document.createElement("div");
    item.textContent = emp.displayname;
    item.style.padding = "6px";
    item.style.cursor = "pointer";

    item.onclick = () => {
      selectedEmployee = emp;
      document.getElementById("employeeSearch").value = emp.displayname;
      dropdown.innerHTML = "";
      autofill(emp);
    };

    item.onmouseover = () => item.style.background = "#f0f0f0";
    item.onmouseout = () => item.style.background = "#fff";

    list.appendChild(item);
  });

  dropdown.appendChild(list);
}

// Autofill Jotform fields
function autofill(emp) {
  const pipeValue = [
    emp.displayname || "",
    emp.mail || "",
    emp.jobtitle || "",
    emp.department || "",
    emp.manager || "",
    emp.managermail || "",
    emp.employeeId || "",
    emp.division || ""
  ].join("|");

  console.log("ğŸ“¤ Final pipe value:", pipeValue);

  JFCustomWidget.setFieldsValueById([
    { id: "5", value: emp.displayname || "" },
    { id: "6", value: emp.mail || "" },
    { id: "7", value: emp.jobtitle || "" },
    { id: "8", value: emp.department || "" },
    { id: "9", value: emp.manager || "" },
    { id: "10", value: emp.managermail || "" },
    { id: "11", value: emp.employeeId || "" },
    { id: "12", value: emp.division || "" }
  ]);

  JFCustomWidget.storeToField("widget_input", pipeValue);
}

// Widget engine
function EmployeeWidget() {
  this.init = async function() {
    await loadUsers();
    buildUI();
  };

  this.getData = function() {
    if (!selectedEmployee) return { valid: true, value: "" };
    const e = selectedEmployee;

    return {
      valid: true,
      value: [
        e.displayname, e.mail, e.jobtitle,
        e.department, e.manager, e.managermail,
        e.employeeId, e.division
      ].join("|")
    };
  };
}

// Jotform lifecycle
JFCustomWidget.subscribe("ready", () => {
  const widget = new EmployeeWidget();
  widget.init();

  JFCustomWidget.subscribe("submit", () => {
    JFCustomWidget.sendSubmit(widget.getData());
  });
});
</script>

</body>
</html>
